import{u as g,$ as w,a as b,p as P,r as N,d as A,A as C,k as m,c as p,b as d,f as y,l as R,h as Q,o as v}from"./index-C0cwzbKv.js";import{u as _}from"./useMutation-Bjk-OgRH.js";import{u as j}from"./useReturnVisits-Bx5x2DZr.js";function k(){const l=g();return _({mutationFn:async n=>{await w("people");const s=n.map(r=>b("people",r));return(await Promise.allSettled(s)).filter(r=>r.status==="fulfilled").map(r=>r.value)},onSuccess:()=>{l.invalidateQueries({queryKey:P.all()})}})}function q(){const l=g();return _({mutationFn:async n=>{await w("returnVisits");const s=n.map(r=>b("returnVisits",r));return(await Promise.allSettled(s)).filter(r=>r.status==="fulfilled").map(r=>r.value)},onSuccess:()=>{l.invalidateQueries({queryKey:N.all()})}})}const F={class:"max-w-prose mx-auto py-2 px-3"},B={class:"flex gap-3 justify-center"},K=["href","download"],L={key:0,class:"bg-lemon-600 rounded px-2 py-1 text-lemon-50 cursor-pointer",for:"fileInput"},M=A({__name:"AppConfig",setup(l){const n=C(),s=j(),c=Q(),r=k(),f=q(),h=m(()=>{if(n.isLoading.value||s.isLoading.value)return;const i={people:n.data.value??[],returnVisits:s.data.value??[]},e=new Blob([JSON.stringify(i)],{type:"application/json"});return URL.createObjectURL(e)}),I=m(()=>new Date().toISOString()+".return-visits");function S(i){return Array.isArray(i)?i.every(e=>!(!Number.isInteger(e.id)||typeof(e==null?void 0:e.name)!="string"||!(e!=null&&e.name)||typeof(e==null?void 0:e.colony)!="string"||!(e!=null&&e.colony)||(e==null?void 0:e.description)==null||e!=null&&e.location&&(typeof e.location!="object"||!Number.isFinite(e.location.latitude)||!Number.isFinite(e.location.longitude)||!Number.isFinite(e.location.altitude)))):!1}function x(i,e){return Array.isArray(e)?e.every(t=>!(!i.includes(t.personId)||!t.date||new Date(t.date).toString()==="Invalid Date"||typeof(t==null?void 0:t.topic)!="string"||!(t!=null&&t.topic)||!t.returnDate||new Date(t.returnDate).toString()==="Invalid Date")):!1}async function D(i){if(!confirm(`¿Segura que deseas importar estos datos?
Esto sobreescribirá los datos actuales.`))return;const t=i.target.files;if(!(t!=null&&t[0])){alert("Error en importación de datos");return}try{const u=t[0],o=JSON.parse(await u.text());if(!S(o==null?void 0:o.people))throw new Error("Error en estructura de archivo");const E=o.people.map(({id:a})=>a);if(!x(E,o.returnVisits))throw new Error("Error en estructura de archivo");await r.mutateAsync(o.people.map(a=>({id:a.id,name:a.name,colony:a.colony,description:a.description,location:a.location?{latitude:a.location.latitude,longitude:a.location.longitude,altitude:a.location.altitude}:void 0}))),await f.mutateAsync(o.returnVisits.map(a=>({personId:a.personId,date:new Date(a.date),topic:a.topic,returnDate:new Date(a.returnDate),notes:a.notes}))),c.back()}catch(u){alert(u instanceof Error?u.message:"Error en la importación")}}return(i,e)=>(v(),p("main",F,[d("div",B,[d("a",{href:h.value,download:I.value,class:"bg-asparagus-600 rounded px-2 py-1 text-asparagus-50"}," Exportar datos ",8,K),d("input",{id:"fileInput",class:"hidden",onChange:D,type:"file",accept:".return-visits,application/json"},null,32),!y(f).isPending.value&&!y(r).isPending.value?(v(),p("label",L," Importar datos ")):R("",!0)])]))}});export{M as default};
