import{u as U,x as _,p as S,H as O,i as v,r as I,G as L,d as $,s as H,c as J,q as N,b as Q,e as u,F as h,f as o,t as x,w as C,v as q,n as g,g as w,h as W,k as E,y as X,z as Y,l as Z,m as ee,B as te,o as c}from"./index-BzlAtdqQ.js";import{u as ae}from"./index-2urXqW4y.js";import{u as z,a as D}from"./useAsyncPerson-CKSnThlb.js";import{u as oe}from"./useColonies-BhmOh_xi.js";import{u as K}from"./useMutation-Ca4hD85O.js";import{u as ne}from"./usePersonReturnVisits-03yIQ2au.js";function se({id:l}){const r=U(),{data:d}=z({id:l});return K({mutationFn:_(()=>async n=>{if(!d.value)return Promise.reject(new Error("Original no encontrado"));const s=d.value,p={id:s.id,name:(n.name??s.name).trim(),colony:(n.colony??s.colony).trim(),description:(n.description??s.description).trim(),location:s.location?{latitude:s.location.latitude,longitude:s.location.longitude,altitude:s.location.altitude}:void 0},k=await O("people",v(l),p);return{...p,id:k}}),onSuccess:n=>{r.invalidateQueries({queryKey:S.all()}),r.setQueryData(S.detail(n.id),n)}})}function le({id:l}){const r=U(),{data:d}=ne({personId:l});return K({mutationFn:_(()=>async()=>{var s;await L("people",v(l));const n=((s=d.value)==null?void 0:s.map(p=>L("returnVisits",[v(l),p.date])))??[];await Promise.allSettled(n)}),onSuccess:()=>{var n;r.invalidateQueries({queryKey:S.all()}),r.invalidateQueries({queryKey:I.list(l)}),(n=d.value)==null||n.forEach(s=>{r.invalidateQueries({queryKey:I.detail(l,s.date)})})}})}const ie={class:"max-w-prose mx-auto py-2 px-3"},re={key:0,class:"text-3xl font-bold text-center"},ue={class:"text-3xl font-bold mb-4"},ce={class:"col-span-2"},de=["placeholder"],pe={key:0,class:"text-chili-600"},me={class:"col-span-2"},ye=["placeholder"],ve={key:0,class:"text-chili-600"},fe={id:"colonyList"},be={class:"col-start-2 col-span-2"},xe={class:"flex gap-2"},ge=["disabled"],he=["disabled"],we={key:0,class:"text-chili-600 whitespace-pre-line"},_e={class:"col-span-2"},ke=["placeholder"],Pe=["disabled"],Ce={async beforeRouteEnter(l,r,d){try{await D({id:parseInt(l.params.id,10)}),d()}catch{d({name:"NotFound"})}}},Ie=$({...Ce,__name:"PeopleEdit",props:{id:{}},setup(l){var V,F,R;const r=ee(),d=oe(),n=ae({immediate:!1});H(a=>{D({id:parseInt(a.params.id,10)}).catch(()=>{r.replace({name:"NotFound"})})});const s=l,p=_(()=>s.id),k=z({id:p}),m=_(()=>k.data.value),b=se({id:p}),B=le({id:p}),i=J({name:((V=m.value)==null?void 0:V.name)??"",colony:((F=m.value)==null?void 0:F.colony)??"",description:((R=m.value)==null?void 0:R.description)??""});N(m,a=>{a&&(i.name=a.name,i.colony=a.colony,i.description=a.description)});const t=Q({}),f=Q(!1);async function P(a){if(!b.isPending.value&&!Object.values(t.value).some(e=>e))try{if(await b.mutateAsync("location"in a?{location:a.location}:{name:a.name,colony:a.colony,description:a.description}),!("location"in a))return r.push({name:"PeopleShow",params:{id:p.value}});f.value=!0,setTimeout(()=>{f.value=!1},2e3)}catch(e){console.info(e),alert(`Error guardando los datos
Por favor intenta de nuevo`)}}function A(){i.name||(t.value={...t.value,name:"Falta nombre"}),i.colony||(t.value={...t.value,colony:"Falta colonia"}),P(i)}function M(){n.resume(),N([n.coords,n.error],async([a,e])=>{if(e){t.value={...t.value,location:`Error actualizando la ubicación.
Revisa que la aplicación tenga los permisos necesarios.`};return}t.value={...t.value,location:""},P({location:{latitude:a.latitude,longitude:a.longitude,altitude:a.altitude}})},{once:!0})}function G(){P({location:void 0})}async function T(){if(confirm("¿Segura que deseas eliminar a esta persona?"))try{await B.mutateAsync(),r.go(-2)}catch(e){console.info(e)}}return(a,e)=>{const j=te("RouterLink");return c(),u("main",ie,[m.value?(c(),u(h,{key:1},[o("h1",ue,"Editar persona: "+x(m.value.name),1),o("form",{class:"grid grid-cols-3 gap-2 gap-y-3",onSubmit:Z(A,["prevent"])},[e[6]||(e[6]=o("label",{class:"text-right",for:"name"},"Nombre",-1)),o("div",ce,[C(o("input",{id:"name",class:g(["block dark:text-lemon-50 px-2 py-1 max-w-full rounded-sm border","h-8 w-full",t.value.name?"border-chili-400 accent-chili-600":"border-asparagus-100 accent-asparagus-600"]),type:"text",name:"name","onUpdate:modelValue":e[0]||(e[0]=y=>i.name=y),onInput:e[1]||(e[1]=y=>t.value.name=""),placeholder:m.value.name,required:""},null,42,de),[[q,i.name]]),t.value.name?(c(),u("small",pe,x(t.value.name),1)):w("",!0)]),e[7]||(e[7]=o("label",{class:"text-right",for:"colony"},"Colonia",-1)),o("div",me,[C(o("input",{id:"colony",class:g(["block dark:text-lemon-50 px-2 py-1 max-w-full rounded-sm border","h-8 w-full",t.value.colony?"border-chili-400 accent-chili-600":"border-asparagus-100 accent-asparagus-600"]),type:"text",name:"colony",list:"colonyList","onUpdate:modelValue":e[2]||(e[2]=y=>i.colony=y),onInput:e[3]||(e[3]=y=>t.value.colony=""),placeholder:m.value.colony,required:""},null,42,ye),[[q,i.colony]]),t.value.colony?(c(),u("small",ve,x(t.value.colony),1)):w("",!0),o("datalist",fe,[(c(!0),u(h,null,W(v(d),y=>(c(),u("option",{key:y},x(y),1))),128))])]),o("div",be,[o("div",xe,[o("button",{class:g(["flex-1 px-2 py-1 rounded","disabled:cursor-not-allowed disabled:grayscale",t.value.location?"bg-chili-600 text-chili-50":"bg-lemon-500"]),type:"button",onClick:M,disabled:v(b).isPending.value||f.value},[f.value?(c(),u(h,{key:0},[E(" Ubicación actualizada ")],64)):(c(),u(h,{key:1},[E("Actualizar ubicación")],64))],10,ge),m.value.location&&!f.value?(c(),u("button",{key:0,class:g(["flex-1 px-2 py-1 rounded text-fawn-50","bg-fawn-600 disabled:cursor-not-allowed disabled:grayscale"]),type:"button",onClick:G,disabled:v(b).isPending.value||f.value}," Eliminar ubicación ",8,he)):w("",!0)]),t.value.location?(c(),u("small",we,x(t.value.location),1)):w("",!0)]),e[8]||(e[8]=o("label",{class:"text-right",for:"description"},"Descripción",-1)),o("div",_e,[C(o("textarea",{id:"description",class:g(["block dark:text-lemon-50 px-2 py-1 max-w-full rounded-sm border","resize-y min-h-16 max-h-72 w-full"]),rows:"8",name:"description","onUpdate:modelValue":e[4]||(e[4]=y=>i.description=y),placeholder:m.value.description,maxlength:"250"},null,8,ke),[[q,i.description]])]),X(j,{class:"col-start-2 border underline border-asparagus-600 rounded px-2 py-1 text-asparagus-600 text-center",to:{name:"PeopleShow",params:{id:p.value}}},{default:Y(()=>e[5]||(e[5]=[E(" Cancelar ")])),_:1},8,["to"]),o("button",{class:"col-start-3 bg-asparagus-600 rounded px-2 py-1 text-lemon-50 disabled:cursor-not-allowed disabled:grayscale",type:"submit",disabled:v(b).isPending.value}," Guardar ",8,Pe),o("button",{class:"col-start-2 bg-fawn-600 rounded px-2 py-1 text-fawn-50 text-center",onClick:T,type:"button"}," Eliminar ")],32)],64)):(c(),u("h1",re,"Error"))])}}});export{Ie as default};
