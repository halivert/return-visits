import{x as J,r as D,y as W,u as A,m as x,f as r,z as L,a as X,A as Y,d as Z,B as V,k as h,c,F,g as f,t as B,i as _,b as i,e as u,w as I,C as ee,n as re,_ as N,h as $,j as te,s as oe,o as g,v as ae}from"./index-CnAH4MzP.js";import{u as se,g as w,a as U}from"./getDateTimeForInput-B2EoPFs7.js";import{u as j}from"./useMutation-BHqPHaoY.js";import{u as ne,_ as b,a as le}from"./VTextarea.vue_vue_type_script_setup_true_lang-CHI2HqnE.js";import"./useReturnVisits-Buc7cR3c.js";function O({personId:n,date:l}){return J({queryKey:D.detail(n,l),queryFn:({queryKey:d})=>W("returnVisits",[d[2],d[3]])})}function de({personId:n,date:l}){const d=A(),{data:T}=O({personId:n,date:l});return j({mutationFn:x(()=>async s=>{var y;if(!T.value)return Promise.reject(new Error("Revisita no encontrada"));const p=T.value,v={personId:s.personId??p.personId,date:s.date??p.date,topic:(s.topic??p.topic).trim(),returnDate:s.returnDate??p.returnDate,notes:(y=s.notes??p.notes)==null?void 0:y.trim()};return r(n)!==v.personId||r(l).toISOString()!==v.date.toISOString()?(await L("returnVisits",[r(n),r(l)]),await X("returnVisits",v)):await Y("returnVisits",[r(n),r(l)],v),v}),onSuccess:s=>{d.invalidateQueries({queryKey:D.list(s.personId)}),d.setQueryData(D.detail(s.personId,s.date),s),s.personId!==r(n)&&d.invalidateQueries({queryKey:D.list(n)}),(s.personId!==r(n)||s.date!==r(l))&&d.invalidateQueries({queryKey:D.detail(n,l)})}})}function ie({personId:n,date:l}){const d=A();return j({mutationFn:x(()=>async()=>{await L("returnVisits",[r(n),r(l)])}),onSuccess:()=>{d.invalidateQueries({queryKey:D.list(n)}),d.removeQueries({queryKey:D.detail(n,l)})}})}const ue=["value"],me={class:"col-span-2"},pe={class:"flex flex-wrap gap-2"},fe={class:"col-span-2"},ve={class:"flex flex-wrap gap-2"},xe=Z({__name:"ReturnVisitsEdit",props:{id:{},date:{}},setup(n){var k,R,C,Q,E,P,K;const l=te(),d=n,T=x(()=>d.id),s=x(()=>d.date),p=de({personId:T,date:s}),v=ie({personId:T,date:s}),y=O({personId:T,date:s}),m=x(()=>y.data.value),z=se(),M=V(),S=x(()=>M.data.value??[]),e=ne({personId:(k=m.value)==null?void 0:k.personId,topic:(R=m.value)==null?void 0:R.topic,date:w((C=m.value)==null?void 0:C.date),time:U((Q=m.value)==null?void 0:Q.date),returnDate:w((E=m.value)==null?void 0:E.returnDate),returnTime:U((P=m.value)==null?void 0:P.returnDate),notes:(K=m.value)==null?void 0:K.notes});h(m,a=>{e.personId=a==null?void 0:a.personId,e.topic=a==null?void 0:a.topic,e.date=w(a==null?void 0:a.date),e.time=U(a==null?void 0:a.date),e.returnDate=w(a==null?void 0:a.returnDate),e.returnTime=U(a==null?void 0:a.returnDate),e.notes=a==null?void 0:a.notes});async function G(){try{await v.mutateAsync(),l.back()}catch(a){console.info(a)}}async function H(){if(p.isPending.value)return;e.personId||(e.errors.personId="Elige a la persona"),e.topic||(e.errors.topic="Falta tema"),e.date||(e.errors.date="Falta fecha"),e.time||(e.errors.time="Falta hora"),e.returnDate||(e.errors.returnDate="Falta fecha de revisita"),e.returnTime||(e.errors.returnTime="Falta hora de revisita");const a=new Date(e.date+"T"+e.time),t=new Date(e.returnDate+"T"+e.returnTime);if(a.getTime()>t.getTime()&&(e.errors.returnDate="Fecha de revisita tiene que ser posterior a fecha de visita"),!Object.values(e.errors).some(Boolean))try{await p.mutateAsync({personId:e.personId,date:a,topic:e.topic,returnDate:t,notes:e.notes}),l.back()}catch(q){console.info(q),alert(`Error guardando los datos
Por favor intenta de nuevo`)}}return(a,t)=>{const q=oe("RouterLink");return g(),c("div",null,[r(y).isLoading.value?(g(),c(F,{key:0},[f("Cargando...")],64)):r(y).error.value||!m.value?(g(),c(F,{key:1},[f(B(r(y).error.value||"Error"),1)],64)):(g(),c("form",{key:2,class:"grid grid-cols-3 gap-2 gap-y-3",onSubmit:_(H,["prevent"])},[S.value.length>1?(g(),c(F,{key:0},[t[14]||(t[14]=i("label",{class:"text-right",for:"personId"},"Persona",-1)),u(ee,{id:"personId","div-class":"col-span-2",modelValue:r(e).personId,"onUpdate:modelValue":t[0]||(t[0]=o=>r(e).personId=o),errors:r(e).errors.personId,"onUpdate:errors":t[1]||(t[1]=o=>r(e).errors.personId=o)},{default:I(()=>[(g(!0),c(F,null,ae(S.value,o=>(g(),c("option",{key:o.id,value:o.id},B(o.name),9,ue))),128))]),_:1},8,["modelValue","errors"])],64)):re("",!0),t[18]||(t[18]=i("div",{class:"text-right"},[i("label",{for:"date"},"Fecha"),f(" y "),i("label",{for:"time"},"hora")],-1)),i("div",me,[i("div",pe,[u(b,{id:"date","div-class":"flex-1",type:"date",modelValue:r(e).date,"onUpdate:modelValue":t[2]||(t[2]=o=>r(e).date=o),errors:r(e).errors.date,"onUpdate:errors":t[3]||(t[3]=o=>r(e).errors.date=o),"hide-errors":"",required:""},null,8,["modelValue","errors"]),u(b,{id:"time","div-class":"flex-1",type:"time",modelValue:r(e).time,"onUpdate:modelValue":t[4]||(t[4]=o=>r(e).time=o),errors:r(e).errors.time,"onUpdate:errors":t[5]||(t[5]=o=>r(e).errors.time=o),"hide-errors":"",required:""},null,8,["modelValue","errors"])]),u(N,{errors:[r(e).errors.date,r(e).errors.time]},null,8,["errors"])]),t[19]||(t[19]=i("label",{class:"text-right",for:"topic"},"Tema",-1)),u(b,{id:"topic","div-class":"col-span-2",modelValue:r(e).topic,"onUpdate:modelValue":t[6]||(t[6]=o=>r(e).topic=o),errors:r(e).errors.topic,"onUpdate:errors":t[7]||(t[7]=o=>r(e).errors.topic=o),list:r(z),required:""},null,8,["modelValue","errors","list"]),t[20]||(t[20]=i("div",{class:"text-right"},[i("label",{for:"returnDate"},"Fecha"),f(" y "),i("label",{for:"returnTime"},"hora"),f(" de revisita ")],-1)),i("div",fe,[i("div",ve,[u(b,{id:"returnDate","div-class":"flex-1",type:"date",modelValue:r(e).returnDate,"onUpdate:modelValue":t[8]||(t[8]=o=>r(e).returnDate=o),errors:r(e).errors.returnDate,"onUpdate:errors":t[9]||(t[9]=o=>r(e).errors.returnDate=o),min:r(e).date,"hide-errors":"",required:""},null,8,["modelValue","errors","min"]),u(b,{id:"returnTime","div-class":"flex-1",type:"time",modelValue:r(e).returnTime,"onUpdate:modelValue":t[10]||(t[10]=o=>r(e).returnTime=o),errors:r(e).errors.returnTime,"onUpdate:errors":t[11]||(t[11]=o=>r(e).errors.returnTime=o),"hide-errors":"",required:""},null,8,["modelValue","errors"])]),u(N,{errors:[r(e).errors.returnDate,r(e).errors.returnTime]},null,8,["errors"])]),t[21]||(t[21]=i("label",{class:"text-right",for:"notes"},"Notas",-1)),u(le,{"div-class":"col-span-2",id:"notes",class:"resize-y min-h-16 max-h-72",modelValue:r(e).notes,"onUpdate:modelValue":t[12]||(t[12]=o=>r(e).notes=o),errors:r(e).errors.notes,"onUpdate:errors":t[13]||(t[13]=o=>r(e).errors.notes=o)},null,8,["modelValue","errors"]),u(q,{class:"col-start-2 border underline border-asparagus-600 rounded px-2 py-1 text-asparagus-600 text-center",to:{name:"PeopleShow",params:{id:a.id}}},{default:I(()=>t[15]||(t[15]=[f(" Cancelar ")])),_:1},8,["to"]),u($,{color:"asparagus",type:"submit"},{default:I(()=>t[16]||(t[16]=[f("Guardar")])),_:1}),u($,{class:"col-start-2",color:"fawn",onClick:G,type:"button"},{default:I(()=>t[17]||(t[17]=[f(" Eliminar ")])),_:1})],32))])}}});export{xe as default};
