import{u as A,m as V,p as E,A as O,f as a,r as U,z as R,d as T,l as H,E as N,k as Q,c as x,F as C,b as p,t as J,e as m,w as P,G as W,h as k,H as X,n as Y,_ as Z,i as ee,j as oe,s as ae,o as g,g as b}from"./index-CnAH4MzP.js";import{u as te}from"./index-6JsNawBe.js";import{u as B,a as K}from"./useAsyncPerson-Dy8sbrTl.js";import{u as re}from"./useColonies-3HQraLB9.js";import{u as L}from"./useMutation-BHqPHaoY.js";import{u as ne}from"./usePersonReturnVisits-CvRw9vWq.js";import{u as se,_ as z,a as le}from"./VTextarea.vue_vue_type_script_setup_true_lang-CHI2HqnE.js";function ie({id:n}){const l=A(),{data:d}=B({id:n});return L({mutationFn:V(()=>async r=>{if(!d.value)return Promise.reject(new Error("Original no encontrado"));const s=d.value,i="location"in r?r.location:s.location,w={id:s.id,name:(r.name??s.name).trim(),colony:(r.colony??s.colony).trim(),description:(r.description??s.description).trim(),location:i?{latitude:i.latitude,longitude:i.longitude,altitude:i.altitude}:void 0},f=await O("people",a(n),w);return{...w,id:f}}),onSuccess:r=>{l.invalidateQueries({queryKey:E.all()}),l.setQueryData(E.detail(r.id),r)}})}function ue({id:n}){const l=A(),{data:d}=ne({personId:n});return L({mutationFn:V(()=>async()=>{var s;await R("people",a(n));const r=((s=d.value)==null?void 0:s.map(i=>R("returnVisits",[a(n),i.date])))??[];await Promise.allSettled(r)}),onSuccess:()=>{var r;l.invalidateQueries({queryKey:E.all()}),l.invalidateQueries({queryKey:U.list(n)}),(r=d.value)==null||r.forEach(s=>{l.invalidateQueries({queryKey:U.detail(n,s.date)})})}})}const ce={class:"max-w-prose mx-auto py-2 px-3"},de={key:0,class:"text-3xl font-bold text-center"},me={class:"text-3xl font-bold mb-4"},pe={class:"col-start-2 col-span-2"},fe={class:"flex gap-2"},ye={async beforeRouteEnter(n,l,d){try{await K({id:parseInt(n.params.id,10)}),d()}catch{d({name:"NotFound"})}}},Ve=T({...ye,__name:"PeopleEdit",props:{id:{}},setup(n){var F,h,q,S;const l=oe(),d=re(),r=te({immediate:!1});H(t=>{K({id:parseInt(t.params.id,10)}).catch(()=>{l.replace({name:"NotFound"})})});const s=n,i=V(()=>s.id),w=B({id:i}),f=N(!1),u=V(()=>w.data.value),y=ie({id:i}),D=ue({id:i}),o=se({name:(F=u.value)==null?void 0:F.name,colony:(h=u.value)==null?void 0:h.colony,description:(q=u.value)==null?void 0:q.description,location:(S=u.value)==null?void 0:S.location});Q(u,t=>{o.name=t==null?void 0:t.name,o.colony=t==null?void 0:t.colony,o.description=t==null?void 0:t.description});const v=N(!1);async function I(){if(!y.isPending.value&&(o.name||(o.errors.name="Falta nombre"),o.colony||(o.errors.colony="Falta colonia"),!Object.values(o.errors).some(Boolean)))try{return await y.mutateAsync(o),l.back()}catch(t){console.info(t)}}async function _(t){try{o.location=t,await y.mutateAsync(o),v.value=!0,setTimeout(()=>{v.value=!1},2e3)}catch(e){o.errors.location=e instanceof Error?e.message:`${e}`}}function $(){o.errors.location="",f.value=!0,r.resume(),Q([r.coords,r.error],([t,e])=>{if(f.value=!1,e){o.errors.location=`Error actualizando la ubicación.
Revisa que la aplicación tenga los permisos necesarios.`;return}_(t)},{once:!0})}function j(){_(void 0)}async function G(){if(confirm("¿Segura que deseas eliminar a esta persona?"))try{await D.mutateAsync(),l.go(-2)}catch(e){console.info(e)}}return(t,e)=>{const M=ae("RouterLink");return g(),x("main",ce,[u.value?(g(),x(C,{key:1},[p("h1",me,"Editar persona: "+J(u.value.name),1),p("form",{class:"grid grid-cols-3 gap-2 gap-y-3",onSubmit:ee(I,["prevent"])},[e[10]||(e[10]=p("label",{class:"text-right",for:"name"},"Nombre",-1)),m(z,{id:"name","div-class":"col-span-2",modelValue:a(o).name,"onUpdate:modelValue":e[0]||(e[0]=c=>a(o).name=c),errors:a(o).errors.name,"onUpdate:errors":e[1]||(e[1]=c=>a(o).errors.name=c),placeholder:u.value.name,required:""},null,8,["modelValue","errors","placeholder"]),e[11]||(e[11]=p("label",{class:"text-right",for:"colony"},"Colonia",-1)),m(z,{id:"colony","div-class":"col-span-2",list:a(d),modelValue:a(o).colony,"onUpdate:modelValue":e[2]||(e[2]=c=>a(o).colony=c),errors:a(o).errors.colony,"onUpdate:errors":e[3]||(e[3]=c=>a(o).errors.colony=c),placeholder:u.value.colony,required:""},null,8,["list","modelValue","errors","placeholder"]),p("div",pe,[p("div",fe,[m(k,{class:W(["flex-1",a(o).errors.location?"bg-chili-600 text-chili-50 dark:bg-chili-700":"bg-lemon-500 dark:bg-lemon-600"]),type:"button",onClick:$,loading:f.value||a(y).isPending.value||v.value},{default:P(()=>[v.value?(g(),x(C,{key:0},[b(" Ubicación actualizada ")],64)):(g(),x(C,{key:1},[b("Actualizar ubicación")],64))]),_:1},8,["class","loading"]),u.value.location&&!v.value?(g(),X(k,{key:0,color:"fawn",class:"flex-1",type:"button",onClick:j,disabled:f.value||a(y).isPending.value||v.value},{default:P(()=>e[6]||(e[6]=[b(" Eliminar ubicación ")])),_:1},8,["disabled"])):Y("",!0)]),m(Z,{errors:a(o).errors.location},null,8,["errors"])]),e[12]||(e[12]=p("label",{class:"text-right",for:"description"},"Descripción",-1)),m(le,{id:"description","div-class":"col-span-2",class:"resize-y min-h-16 max-h-72",rows:"8",modelValue:a(o).description,"onUpdate:modelValue":e[4]||(e[4]=c=>a(o).description=c),errors:a(o).errors.description,"onUpdate:errors":e[5]||(e[5]=c=>a(o).errors.description=c),placeholder:u.value.description,maxlength:"250"},null,8,["modelValue","errors","placeholder"]),m(M,{class:"col-start-2 border underline border-asparagus-600 rounded px-2 py-1 text-asparagus-600 text-center",to:{name:"PeopleShow",params:{id:i.value}}},{default:P(()=>e[7]||(e[7]=[b(" Cancelar ")])),_:1},8,["to"]),m(k,{class:"col-start-3",color:"asparagus",type:"submit",disabled:a(y).isPending.value},{default:P(()=>e[8]||(e[8]=[b(" Guardar ")])),_:1},8,["disabled"]),m(k,{class:"col-start-2",color:"fawn",onClick:G,type:"button"},{default:P(()=>e[9]||(e[9]=[b(" Eliminar ")])),_:1})],32)],64)):(g(),x("h1",de,"Error"))])}}});export{Ve as default};
