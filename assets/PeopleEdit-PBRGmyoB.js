import{u as N,k as x,p as h,A as $,f as a,r as E,z as F,d as j,j as G,i as S,M as O,c as f,F as w,b as m,t as T,e as v,I as U,g as P,l as H,m as J,w as W,h as X,q as Y,o as b}from"./index-CRgsI8ii.js";import{u as Z}from"./index-DpfKtxat.js";import{u as Q,a as z}from"./useAsyncPerson-DuB1tE7s.js";import{u as ee,a as oe}from"./useForm-DURob298.js";import{u as A,_ as R,b as ae,a as te}from"./VTextarea.vue_vue_type_script_setup_true_lang-Bq3UuHX3.js";import{u as ne}from"./usePersonReturnVisits-D9j_aW2D.js";function re({id:s}){const l=N(),{data:u}=Q({id:s});return A({mutationFn:x(()=>async n=>{if(!u.value)return Promise.reject(new Error("Original no encontrado"));const i=u.value,c="location"in n?n.location:i.location,g={id:i.id,name:(n.name??i.name).trim(),colony:(n.colony??i.colony).trim(),description:(n.description??i.description).trim(),location:c?{latitude:c.latitude,longitude:c.longitude,altitude:c.altitude}:void 0},r=await $("people",a(s),g);return{...g,id:r}}),onSuccess:n=>{l.invalidateQueries({queryKey:h.all()}),l.setQueryData(h.detail(n.id),n)}})}function se({id:s}){const l=N(),{data:u}=ne({personId:s});return A({mutationFn:x(()=>async()=>{var i;await F("people",a(s));const n=((i=u.value)==null?void 0:i.map(c=>F("returnVisits",[a(s),c.date])))??[];await Promise.allSettled(n)}),onSuccess:()=>{var n;l.invalidateQueries({queryKey:h.all()}),l.invalidateQueries({queryKey:E.list(s)}),(n=u.value)==null||n.forEach(i=>{l.invalidateQueries({queryKey:E.detail(s,i.date)})})}})}const ie={class:"max-w-prose mx-auto py-2 px-3"},le={key:0,class:"text-3xl font-bold text-center"},ce={class:"text-3xl font-bold mb-4"},de={class:"col-start-2 col-span-2"},ue={class:"flex gap-2"},me=["disabled"],pe=["disabled"],ye=["disabled"],fe={async beforeRouteEnter(s,l,u){try{await z({id:parseInt(s.params.id,10)}),u()}catch{u({name:"NotFound"})}}},he=j({...fe,__name:"PeopleEdit",props:{id:{}},setup(s){var _,k,C,q;const l=X(),u=ee(),n=Z({immediate:!1});G(t=>{z({id:parseInt(t.params.id,10)}).catch(()=>{l.replace({name:"NotFound"})})});const i=s,c=x(()=>i.id),g=Q({id:c}),r=x(()=>g.data.value),p=re({id:c}),I=se({id:c}),e=oe({name:(_=r.value)==null?void 0:_.name,colony:(k=r.value)==null?void 0:k.colony,description:(C=r.value)==null?void 0:C.description,location:(q=r.value)==null?void 0:q.location});S(r,t=>{e.name=t==null?void 0:t.name,e.colony=t==null?void 0:t.colony,e.description=t==null?void 0:t.description});const y=O(!1);async function K(){if(!p.isPending.value&&(e.name||(e.errors.name="Falta nombre"),e.colony||(e.errors.colony="Falta colonia"),!Object.values(e.errors).some(Boolean)))try{return await p.mutateAsync(e),l.back()}catch(t){console.info(t)}}async function V(t){try{e.location=t,console.info(e),await p.mutateAsync(e),y.value=!0,setTimeout(()=>{y.value=!1},2e3)}catch(o){e.errors.location=o instanceof Error?o.message:`${o}`}}function B(){n.resume(),S([n.coords,n.error],([t,o])=>{if(o){e.errors.location=`Error actualizando la ubicación.
Revisa que la aplicación tenga los permisos necesarios.`;return}e.errors.location="",V(t)},{once:!0})}function D(){V(void 0)}async function L(){if(confirm("¿Segura que deseas eliminar a esta persona?"))try{await I.mutateAsync(),l.go(-2)}catch(o){console.info(o)}}return(t,o)=>{const M=Y("RouterLink");return b(),f("main",ie,[r.value?(b(),f(w,{key:1},[m("h1",ce,"Editar persona: "+T(r.value.name),1),m("form",{class:"grid grid-cols-3 gap-2 gap-y-3",onSubmit:W(K,["prevent"])},[o[7]||(o[7]=m("label",{class:"text-right",for:"name"},"Nombre",-1)),v(R,{id:"name","div-class":"col-span-2",modelValue:a(e).name,"onUpdate:modelValue":o[0]||(o[0]=d=>a(e).name=d),errors:a(e).errors.name,"onUpdate:errors":o[1]||(o[1]=d=>a(e).errors.name=d),placeholder:r.value.name,required:""},null,8,["modelValue","errors","placeholder"]),o[8]||(o[8]=m("label",{class:"text-right",for:"colony"},"Colonia",-1)),v(R,{id:"colony","div-class":"col-span-2",list:a(u),modelValue:a(e).colony,"onUpdate:modelValue":o[2]||(o[2]=d=>a(e).colony=d),errors:a(e).errors.colony,"onUpdate:errors":o[3]||(o[3]=d=>a(e).errors.colony=d),placeholder:r.value.colony,required:""},null,8,["list","modelValue","errors","placeholder"]),m("div",de,[m("div",ue,[m("button",{class:U(["flex-1 px-2 py-1 rounded","disabled:cursor-not-allowed disabled:grayscale",a(e).errors.location?"bg-chili-600 text-chili-50":"bg-lemon-500"]),type:"button",onClick:B,disabled:a(p).isPending.value||y.value},[y.value?(b(),f(w,{key:0},[P(" Ubicación actualizada ")],64)):(b(),f(w,{key:1},[P("Actualizar ubicación")],64))],10,me),r.value.location&&!y.value?(b(),f("button",{key:0,class:U(["flex-1 px-2 py-1 rounded text-fawn-50","bg-fawn-600 disabled:cursor-not-allowed disabled:grayscale"]),type:"button",onClick:D,disabled:a(p).isPending.value||y.value}," Eliminar ubicación ",8,pe)):H("",!0)]),v(ae,{errors:a(e).errors.location},null,8,["errors"])]),o[9]||(o[9]=m("label",{class:"text-right",for:"description"},"Descripción",-1)),v(te,{id:"description","div-class":"col-span-2",class:"resize-y min-h-16 max-h-72",rows:"8",modelValue:a(e).description,"onUpdate:modelValue":o[4]||(o[4]=d=>a(e).description=d),errors:a(e).errors.description,"onUpdate:errors":o[5]||(o[5]=d=>a(e).errors.description=d),placeholder:r.value.description,maxlength:"250"},null,8,["modelValue","errors","placeholder"]),v(M,{class:"col-start-2 border underline border-asparagus-600 rounded px-2 py-1 text-asparagus-600 text-center",to:{name:"PeopleShow",params:{id:c.value}}},{default:J(()=>o[6]||(o[6]=[P(" Cancelar ")])),_:1},8,["to"]),m("button",{class:"col-start-3 bg-asparagus-600 rounded px-2 py-1 text-lemon-50 disabled:cursor-not-allowed disabled:grayscale",type:"submit",disabled:a(p).isPending.value}," Guardar ",8,ye),m("button",{class:"col-start-2 bg-fawn-600 rounded px-2 py-1 text-fawn-50 text-center",onClick:L,type:"button"}," Eliminar ")],32)],64)):(b(),f("h1",le,"Error"))])}}});export{he as default};
