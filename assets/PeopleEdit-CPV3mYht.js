import{u as N,k as x,p as h,z as j,f as a,r as q,y as F,d as M,j as G,i as S,C as O,c as f,F as w,b as m,t as T,e as v,E as U,g as P,l as H,_ as J,m as W,w as X,h as Y,q as Z,o as b}from"./index-C0cwzbKv.js";import{u as ee}from"./index-DUOUsTEy.js";import{u as Q,a as z}from"./useAsyncPerson-BsWSnyTm.js";import{u as oe}from"./useColonies-Bk0w_DU6.js";import{u as K}from"./useMutation-Bjk-OgRH.js";import{u as ae}from"./usePersonReturnVisits-8vQ3MJOI.js";import{u as te,_ as R,a as re}from"./VTextarea.vue_vue_type_script_setup_true_lang-f4fS5TxM.js";function ne({id:s}){const l=N(),{data:d}=Q({id:s});return K({mutationFn:x(()=>async r=>{if(!d.value)return Promise.reject(new Error("Original no encontrado"));const i=d.value,c="location"in r?r.location:i.location,g={id:i.id,name:(r.name??i.name).trim(),colony:(r.colony??i.colony).trim(),description:(r.description??i.description).trim(),location:c?{latitude:c.latitude,longitude:c.longitude,altitude:c.altitude}:void 0},n=await j("people",a(s),g);return{...g,id:n}}),onSuccess:r=>{l.invalidateQueries({queryKey:h.all()}),l.setQueryData(h.detail(r.id),r)}})}function se({id:s}){const l=N(),{data:d}=ae({personId:s});return K({mutationFn:x(()=>async()=>{var i;await F("people",a(s));const r=((i=d.value)==null?void 0:i.map(c=>F("returnVisits",[a(s),c.date])))??[];await Promise.allSettled(r)}),onSuccess:()=>{var r;l.invalidateQueries({queryKey:h.all()}),l.invalidateQueries({queryKey:q.list(s)}),(r=d.value)==null||r.forEach(i=>{l.invalidateQueries({queryKey:q.detail(s,i.date)})})}})}const ie={class:"max-w-prose mx-auto py-2 px-3"},le={key:0,class:"text-3xl font-bold text-center"},ce={class:"text-3xl font-bold mb-4"},ue={class:"col-start-2 col-span-2"},de={class:"flex gap-2"},me=["disabled"],pe=["disabled"],ye=["disabled"],fe={async beforeRouteEnter(s,l,d){try{await z({id:parseInt(s.params.id,10)}),d()}catch{d({name:"NotFound"})}}},_e=M({...fe,__name:"PeopleEdit",props:{id:{}},setup(s){var V,C,k,E;const l=Y(),d=oe(),r=ee({immediate:!1});G(t=>{z({id:parseInt(t.params.id,10)}).catch(()=>{l.replace({name:"NotFound"})})});const i=s,c=x(()=>i.id),g=Q({id:c}),n=x(()=>g.data.value),p=ne({id:c}),A=se({id:c}),e=te({name:(V=n.value)==null?void 0:V.name,colony:(C=n.value)==null?void 0:C.colony,description:(k=n.value)==null?void 0:k.description,location:(E=n.value)==null?void 0:E.location});S(n,t=>{e.name=t==null?void 0:t.name,e.colony=t==null?void 0:t.colony,e.description=t==null?void 0:t.description});const y=O(!1);async function B(){if(!p.isPending.value&&(e.name||(e.errors.name="Falta nombre"),e.colony||(e.errors.colony="Falta colonia"),!Object.values(e.errors).some(Boolean)))try{return await p.mutateAsync(e),l.back()}catch(t){console.info(t)}}async function _(t){try{e.location=t,console.info(e),await p.mutateAsync(e),y.value=!0,setTimeout(()=>{y.value=!1},2e3)}catch(o){e.errors.location=o instanceof Error?o.message:`${o}`}}function D(){r.resume(),S([r.coords,r.error],([t,o])=>{if(o){e.errors.location=`Error actualizando la ubicación.
Revisa que la aplicación tenga los permisos necesarios.`;return}e.errors.location="",_(t)},{once:!0})}function I(){_(void 0)}async function L(){if(confirm("¿Segura que deseas eliminar a esta persona?"))try{await A.mutateAsync(),l.go(-2)}catch(o){console.info(o)}}return(t,o)=>{const $=Z("RouterLink");return b(),f("main",ie,[n.value?(b(),f(w,{key:1},[m("h1",ce,"Editar persona: "+T(n.value.name),1),m("form",{class:"grid grid-cols-3 gap-2 gap-y-3",onSubmit:X(B,["prevent"])},[o[7]||(o[7]=m("label",{class:"text-right",for:"name"},"Nombre",-1)),v(R,{id:"name","div-class":"col-span-2",modelValue:a(e).name,"onUpdate:modelValue":o[0]||(o[0]=u=>a(e).name=u),errors:a(e).errors.name,"onUpdate:errors":o[1]||(o[1]=u=>a(e).errors.name=u),placeholder:n.value.name,required:""},null,8,["modelValue","errors","placeholder"]),o[8]||(o[8]=m("label",{class:"text-right",for:"colony"},"Colonia",-1)),v(R,{id:"colony","div-class":"col-span-2",list:a(d),modelValue:a(e).colony,"onUpdate:modelValue":o[2]||(o[2]=u=>a(e).colony=u),errors:a(e).errors.colony,"onUpdate:errors":o[3]||(o[3]=u=>a(e).errors.colony=u),placeholder:n.value.colony,required:""},null,8,["list","modelValue","errors","placeholder"]),m("div",ue,[m("div",de,[m("button",{class:U(["flex-1 px-2 py-1 rounded","disabled:cursor-not-allowed disabled:grayscale",a(e).errors.location?"bg-chili-600 text-chili-50":"bg-lemon-500"]),type:"button",onClick:D,disabled:a(p).isPending.value||y.value},[y.value?(b(),f(w,{key:0},[P(" Ubicación actualizada ")],64)):(b(),f(w,{key:1},[P("Actualizar ubicación")],64))],10,me),n.value.location&&!y.value?(b(),f("button",{key:0,class:U(["flex-1 px-2 py-1 rounded text-fawn-50","bg-fawn-600 disabled:cursor-not-allowed disabled:grayscale"]),type:"button",onClick:I,disabled:a(p).isPending.value||y.value}," Eliminar ubicación ",8,pe)):H("",!0)]),v(J,{errors:a(e).errors.location},null,8,["errors"])]),o[9]||(o[9]=m("label",{class:"text-right",for:"description"},"Descripción",-1)),v(re,{id:"description","div-class":"col-span-2",class:"resize-y min-h-16 max-h-72",rows:"8",modelValue:a(e).description,"onUpdate:modelValue":o[4]||(o[4]=u=>a(e).description=u),errors:a(e).errors.description,"onUpdate:errors":o[5]||(o[5]=u=>a(e).errors.description=u),placeholder:n.value.description,maxlength:"250"},null,8,["modelValue","errors","placeholder"]),v($,{class:"col-start-2 border underline border-asparagus-600 rounded px-2 py-1 text-asparagus-600 text-center",to:{name:"PeopleShow",params:{id:c.value}}},{default:W(()=>o[6]||(o[6]=[P(" Cancelar ")])),_:1},8,["to"]),m("button",{class:"col-start-3 bg-asparagus-600 rounded px-2 py-1 text-lemon-50 disabled:cursor-not-allowed disabled:grayscale",type:"submit",disabled:a(p).isPending.value}," Guardar ",8,ye),m("button",{class:"col-start-2 bg-fawn-600 rounded px-2 py-1 text-fawn-50 text-center",onClick:L,type:"button"}," Eliminar ")],32)],64)):(b(),f("h1",le,"Error"))])}}});export{_e as default};
