import{v as H,r as g,x as J,u as A,k as b,f as r,y as L,a as W,z as X,d as Y,A as Z,i as V,c as y,F,g as x,t as K,w as h,b as l,e as u,m as B,B as _,l as ee,_ as N,h as re,q as te,o as c,s as oe}from"./index-D6IdYIOx.js";import{u as ae,g as I,a as w}from"./getDateTimeForInput-CEVL2o50.js";import{u as $}from"./useMutation-BFuSot1U.js";import{u as se,_ as T,a as ne}from"./VTextarea.vue_vue_type_script_setup_true_lang-TlYwyJ6E.js";import"./useReturnVisits-BBX5RBm0.js";function O({personId:n,date:d}){return H({queryKey:g.detail(n,d),queryFn:({queryKey:i})=>J("returnVisits",[i[2],i[3]])})}function le({personId:n,date:d}){const i=A(),{data:D}=O({personId:n,date:d});return $({mutationFn:b(()=>async s=>{var v;if(!D.value)return Promise.reject(new Error("Revisita no encontrada"));const m=D.value,f={personId:s.personId??m.personId,date:s.date??m.date,topic:(s.topic??m.topic).trim(),returnDate:s.returnDate??m.returnDate,notes:(v=s.notes??m.notes)==null?void 0:v.trim()};return r(n)!==f.personId||r(d).toISOString()!==f.date.toISOString()?(await L("returnVisits",[r(n),r(d)]),await W("returnVisits",f)):await X("returnVisits",[r(n),r(d)],f),f}),onSuccess:s=>{i.invalidateQueries({queryKey:g.list(s.personId)}),i.setQueryData(g.detail(s.personId,s.date),s),s.personId!==r(n)&&i.invalidateQueries({queryKey:g.list(n)}),(s.personId!==r(n)||s.date!==r(d))&&i.invalidateQueries({queryKey:g.detail(n,d)})}})}function de({personId:n,date:d}){const i=A();return $({mutationFn:b(()=>async()=>{await L("returnVisits",[r(n),r(d)])}),onSuccess:()=>{i.invalidateQueries({queryKey:g.list(n)}),i.removeQueries({queryKey:g.detail(n,d)})}})}const ie=["value"],ue={class:"col-span-2"},pe={class:"flex flex-wrap gap-2"},me={class:"col-span-2"},fe={class:"flex flex-wrap gap-2"},xe=Y({__name:"ReturnVisitsEdit",props:{id:{},date:{}},setup(n){var S,k,R,Q,C,E,P;const d=re(),i=n,D=b(()=>i.id),s=b(()=>i.date),m=le({personId:D,date:s}),f=de({personId:D,date:s}),v=O({personId:D,date:s}),p=b(()=>v.data.value),j=ae(),z=Z(),U=b(()=>z.data.value??[]),e=se({personId:(S=p.value)==null?void 0:S.personId,topic:(k=p.value)==null?void 0:k.topic,date:I((R=p.value)==null?void 0:R.date),time:w((Q=p.value)==null?void 0:Q.date),returnDate:I((C=p.value)==null?void 0:C.returnDate),returnTime:w((E=p.value)==null?void 0:E.returnDate),notes:(P=p.value)==null?void 0:P.notes});V(p,a=>{e.personId=a==null?void 0:a.personId,e.topic=a==null?void 0:a.topic,e.date=I(a==null?void 0:a.date),e.time=w(a==null?void 0:a.date),e.returnDate=I(a==null?void 0:a.returnDate),e.returnTime=w(a==null?void 0:a.returnDate),e.notes=a==null?void 0:a.notes});async function M(){try{await f.mutateAsync(),d.back()}catch(a){console.info(a)}}async function G(){if(m.isPending.value)return;e.personId||(e.errors.personId="Elige a la persona"),e.topic||(e.errors.topic="Falta tema"),e.date||(e.errors.date="Falta fecha"),e.time||(e.errors.time="Falta hora"),e.returnDate||(e.errors.returnDate="Falta fecha de revisita"),e.returnTime||(e.errors.returnTime="Falta hora de revisita");const a=new Date(e.date+"T"+e.time),t=new Date(e.returnDate+"T"+e.returnTime);if(a.getTime()>t.getTime()&&(e.errors.returnDate="Fecha de revisita tiene que ser posterior a fecha de visita"),!Object.values(e.errors).some(Boolean))try{await m.mutateAsync({personId:e.personId,date:a,topic:e.topic,returnDate:t,notes:e.notes}),d.back()}catch(q){console.info(q),alert(`Error guardando los datos
Por favor intenta de nuevo`)}}return(a,t)=>{const q=te("RouterLink");return c(),y("div",null,[r(v).isLoading.value?(c(),y(F,{key:0},[x("Cargando...")],64)):r(v).error.value||!p.value?(c(),y(F,{key:1},[x(K(r(v).error.value||"Error"),1)],64)):(c(),y("form",{key:2,class:"grid grid-cols-3 gap-2 gap-y-3",onSubmit:h(G,["prevent"])},[U.value.length>1?(c(),y(F,{key:0},[t[14]||(t[14]=l("label",{class:"text-right",for:"personId"},"Persona",-1)),u(_,{id:"personId","div-class":"col-span-2",modelValue:r(e).personId,"onUpdate:modelValue":t[0]||(t[0]=o=>r(e).personId=o),errors:r(e).errors.personId,"onUpdate:errors":t[1]||(t[1]=o=>r(e).errors.personId=o)},{default:B(()=>[(c(!0),y(F,null,oe(U.value,o=>(c(),y("option",{key:o.id,value:o.id},K(o.name),9,ie))),128))]),_:1},8,["modelValue","errors"])],64)):ee("",!0),t[16]||(t[16]=l("div",{class:"text-right"},[l("label",{for:"date"},"Fecha"),x(" y "),l("label",{for:"time"},"hora")],-1)),l("div",ue,[l("div",pe,[u(T,{id:"date","div-class":"flex-1",type:"date",modelValue:r(e).date,"onUpdate:modelValue":t[2]||(t[2]=o=>r(e).date=o),errors:r(e).errors.date,"onUpdate:errors":t[3]||(t[3]=o=>r(e).errors.date=o),"hide-errors":"",required:""},null,8,["modelValue","errors"]),u(T,{id:"time","div-class":"flex-1",type:"time",modelValue:r(e).time,"onUpdate:modelValue":t[4]||(t[4]=o=>r(e).time=o),errors:r(e).errors.time,"onUpdate:errors":t[5]||(t[5]=o=>r(e).errors.time=o),"hide-errors":"",required:""},null,8,["modelValue","errors"])]),u(N,{errors:[r(e).errors.date,r(e).errors.time]},null,8,["errors"])]),t[17]||(t[17]=l("label",{class:"text-right",for:"topic"},"Tema",-1)),u(T,{id:"topic","div-class":"col-span-2",modelValue:r(e).topic,"onUpdate:modelValue":t[6]||(t[6]=o=>r(e).topic=o),errors:r(e).errors.topic,"onUpdate:errors":t[7]||(t[7]=o=>r(e).errors.topic=o),list:r(j),required:""},null,8,["modelValue","errors","list"]),t[18]||(t[18]=l("div",{class:"text-right"},[l("label",{for:"returnDate"},"Fecha"),x(" y "),l("label",{for:"returnTime"},"hora"),x(" de revisita ")],-1)),l("div",me,[l("div",fe,[u(T,{id:"returnDate","div-class":"flex-1",type:"date",modelValue:r(e).returnDate,"onUpdate:modelValue":t[8]||(t[8]=o=>r(e).returnDate=o),errors:r(e).errors.returnDate,"onUpdate:errors":t[9]||(t[9]=o=>r(e).errors.returnDate=o),min:r(e).date,"hide-errors":"",required:""},null,8,["modelValue","errors","min"]),u(T,{id:"returnTime","div-class":"flex-1",type:"time",modelValue:r(e).returnTime,"onUpdate:modelValue":t[10]||(t[10]=o=>r(e).returnTime=o),errors:r(e).errors.returnTime,"onUpdate:errors":t[11]||(t[11]=o=>r(e).errors.returnTime=o),"hide-errors":"",required:""},null,8,["modelValue","errors"])]),u(N,{errors:[r(e).errors.returnDate,r(e).errors.returnTime]},null,8,["errors"])]),t[19]||(t[19]=l("label",{class:"text-right",for:"notes"},"Notas",-1)),u(ne,{"div-class":"col-span-2",id:"notes",class:"resize-y min-h-16 max-h-72",modelValue:r(e).notes,"onUpdate:modelValue":t[12]||(t[12]=o=>r(e).notes=o),errors:r(e).errors.notes,"onUpdate:errors":t[13]||(t[13]=o=>r(e).errors.notes=o)},null,8,["modelValue","errors"]),u(q,{class:"col-start-2 border underline border-asparagus-600 rounded px-2 py-1 text-asparagus-600 text-center",to:{name:"PeopleShow",params:{id:a.id}}},{default:B(()=>t[15]||(t[15]=[x(" Cancelar ")])),_:1},8,["to"]),t[20]||(t[20]=l("button",{class:"bg-asparagus-600 rounded px-2 py-1 text-lemon-50",type:"submit"}," Guardar ",-1)),l("button",{class:"col-start-2 bg-fawn-600 rounded px-2 py-1 text-fawn-50 text-center",onClick:M,type:"button"}," Eliminar ")],32))])}}});export{xe as default};
