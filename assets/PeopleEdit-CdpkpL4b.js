import{u as Q,m as V,p as C,A as G,f as a,r as U,z as h,d as M,l as O,k as R,E as T,c as g,F as k,b as p,t as H,e as m,w as x,G as J,h as w,H as W,n as X,_ as Y,i as Z,j as ee,s as oe,o as v,g as b}from"./index-CVGw5Sz0.js";import{u as ae}from"./index-Clnrg1YG.js";import{u as z,a as A}from"./useAsyncPerson-DWWVLyRY.js";import{u as te}from"./useColonies-BOsYbehV.js";import{u as B}from"./useMutation-x1iVZiTe.js";import{u as re}from"./usePersonReturnVisits-DHf5t2o3.js";import{u as se,_ as N,a as ne}from"./VTextarea.vue_vue_type_script_setup_true_lang-Nj08pXi5.js";function ie({id:n}){const l=Q(),{data:d}=z({id:n});return B({mutationFn:V(()=>async r=>{if(!d.value)return Promise.reject(new Error("Original no encontrado"));const i=d.value,u="location"in r?r.location:i.location,P={id:i.id,name:(r.name??i.name).trim(),colony:(r.colony??i.colony).trim(),description:(r.description??i.description).trim(),location:u?{latitude:u.latitude,longitude:u.longitude,altitude:u.altitude}:void 0},s=await G("people",a(n),P);return{...P,id:s}}),onSuccess:r=>{l.invalidateQueries({queryKey:C.all()}),l.setQueryData(C.detail(r.id),r)}})}function le({id:n}){const l=Q(),{data:d}=re({personId:n});return B({mutationFn:V(()=>async()=>{var i;await h("people",a(n));const r=((i=d.value)==null?void 0:i.map(u=>h("returnVisits",[a(n),u.date])))??[];await Promise.allSettled(r)}),onSuccess:()=>{var r;l.invalidateQueries({queryKey:C.all()}),l.invalidateQueries({queryKey:U.list(n)}),(r=d.value)==null||r.forEach(i=>{l.invalidateQueries({queryKey:U.detail(n,i.date)})})}})}const ue={class:"max-w-prose mx-auto py-2 px-3"},ce={key:0,class:"text-3xl font-bold text-center"},de={class:"text-3xl font-bold mb-4"},me={class:"col-start-2 col-span-2"},pe={class:"flex gap-2"},fe={async beforeRouteEnter(n,l,d){try{await A({id:parseInt(n.params.id,10)}),d()}catch{d({name:"NotFound"})}}},Ve=M({...fe,__name:"PeopleEdit",props:{id:{}},setup(n){var _,F,q,S;const l=ee(),d=te(),r=ae({immediate:!1});O(t=>{A({id:parseInt(t.params.id,10)}).catch(()=>{l.replace({name:"NotFound"})})});const i=n,u=V(()=>i.id),P=z({id:u}),s=V(()=>P.data.value),f=ie({id:u}),K=le({id:u}),o=se({name:(_=s.value)==null?void 0:_.name,colony:(F=s.value)==null?void 0:F.colony,description:(q=s.value)==null?void 0:q.description,location:(S=s.value)==null?void 0:S.location});R(s,t=>{o.name=t==null?void 0:t.name,o.colony=t==null?void 0:t.colony,o.description=t==null?void 0:t.description});const y=T(!1);async function D(){if(!f.isPending.value&&(o.name||(o.errors.name="Falta nombre"),o.colony||(o.errors.colony="Falta colonia"),!Object.values(o.errors).some(Boolean)))try{return await f.mutateAsync(o),l.back()}catch(t){console.info(t)}}async function E(t){try{o.location=t,console.info(o),await f.mutateAsync(o),y.value=!0,setTimeout(()=>{y.value=!1},2e3)}catch(e){o.errors.location=e instanceof Error?e.message:`${e}`}}function I(){r.resume(),R([r.coords,r.error],([t,e])=>{if(e){o.errors.location=`Error actualizando la ubicación.
Revisa que la aplicación tenga los permisos necesarios.`;return}o.errors.location="",E(t)},{once:!0})}function L(){E(void 0)}async function $(){if(confirm("¿Segura que deseas eliminar a esta persona?"))try{await K.mutateAsync(),l.go(-2)}catch(e){console.info(e)}}return(t,e)=>{const j=oe("RouterLink");return v(),g("main",ue,[s.value?(v(),g(k,{key:1},[p("h1",de,"Editar persona: "+H(s.value.name),1),p("form",{class:"grid grid-cols-3 gap-2 gap-y-3",onSubmit:Z(D,["prevent"])},[e[10]||(e[10]=p("label",{class:"text-right",for:"name"},"Nombre",-1)),m(N,{id:"name","div-class":"col-span-2",modelValue:a(o).name,"onUpdate:modelValue":e[0]||(e[0]=c=>a(o).name=c),errors:a(o).errors.name,"onUpdate:errors":e[1]||(e[1]=c=>a(o).errors.name=c),placeholder:s.value.name,required:""},null,8,["modelValue","errors","placeholder"]),e[11]||(e[11]=p("label",{class:"text-right",for:"colony"},"Colonia",-1)),m(N,{id:"colony","div-class":"col-span-2",list:a(d),modelValue:a(o).colony,"onUpdate:modelValue":e[2]||(e[2]=c=>a(o).colony=c),errors:a(o).errors.colony,"onUpdate:errors":e[3]||(e[3]=c=>a(o).errors.colony=c),placeholder:s.value.colony,required:""},null,8,["list","modelValue","errors","placeholder"]),p("div",me,[p("div",pe,[m(w,{class:J(["flex-1",a(o).errors.location?"bg-chili-600 text-chili-50":"bg-lemon-500"]),type:"button",onClick:I,disabled:a(f).isPending.value||y.value},{default:x(()=>[y.value?(v(),g(k,{key:0},[b(" Ubicación actualizada ")],64)):(v(),g(k,{key:1},[b("Actualizar ubicación")],64))]),_:1},8,["class","disabled"]),s.value.location&&!y.value?(v(),W(w,{key:0,color:"fawn",class:"flex-1",type:"button",onClick:L,disabled:a(f).isPending.value||y.value},{default:x(()=>e[6]||(e[6]=[b(" Eliminar ubicación ")])),_:1},8,["disabled"])):X("",!0)]),m(Y,{errors:a(o).errors.location},null,8,["errors"])]),e[12]||(e[12]=p("label",{class:"text-right",for:"description"},"Descripción",-1)),m(ne,{id:"description","div-class":"col-span-2",class:"resize-y min-h-16 max-h-72",rows:"8",modelValue:a(o).description,"onUpdate:modelValue":e[4]||(e[4]=c=>a(o).description=c),errors:a(o).errors.description,"onUpdate:errors":e[5]||(e[5]=c=>a(o).errors.description=c),placeholder:s.value.description,maxlength:"250"},null,8,["modelValue","errors","placeholder"]),m(j,{class:"col-start-2 border underline border-asparagus-600 rounded px-2 py-1 text-asparagus-600 text-center",to:{name:"PeopleShow",params:{id:u.value}}},{default:x(()=>e[7]||(e[7]=[b(" Cancelar ")])),_:1},8,["to"]),m(w,{class:"col-start-3",color:"asparagus",type:"submit",disabled:a(f).isPending.value},{default:x(()=>e[8]||(e[8]=[b(" Guardar ")])),_:1},8,["disabled"]),m(w,{class:"col-start-2",color:"fawn",onClick:$,type:"button"},{default:x(()=>e[9]||(e[9]=[b(" Eliminar ")])),_:1})],32)],64)):(v(),g("h1",ce,"Error"))])}}});export{Ve as default};
