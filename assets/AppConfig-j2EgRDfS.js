import{u as I,a0 as S,a as D,p as A,r as R,d as j,B as k,E as Q,m,c as q,b as p,e as y,w as v,h as g,f as w,j as B,o as F,g as b}from"./index-C8QBmJ4_.js";import{u as x}from"./useMutation-BQTArVSh.js";import{u as K}from"./useReturnVisits-Cqzu6DOn.js";function L(){const u=I();return x({mutationFn:async l=>{await S("people");const s=l.map(i=>D("people",i));return(await Promise.allSettled(s)).filter(i=>i.status==="fulfilled").map(i=>i.value)},onSuccess:()=>{u.invalidateQueries({queryKey:A.all()})}})}function O(){const u=I();return x({mutationFn:async l=>{await S("returnVisits");const s=l.map(i=>D("returnVisits",i));return(await Promise.allSettled(s)).filter(i=>i.status==="fulfilled").map(i=>i.value)},onSuccess:()=>{u.invalidateQueries({queryKey:R.all()})}})}const J={class:"max-w-prose mx-auto py-2 px-3"},T={class:"flex gap-3 justify-center"},z=j({__name:"AppConfig",setup(u){const l=k(),s=K(),c=B(),i=L(),f=O(),d=Q(),E=m(()=>{if(l.isLoading.value||s.isLoading.value)return;const r={people:l.data.value??[],returnVisits:s.data.value??[]},e=new Blob([JSON.stringify(r)],{type:"application/json"});return URL.createObjectURL(e)}),_=m(()=>new Date().toISOString()+".return-visits");function N(r){return Array.isArray(r)?r.every(e=>!(!Number.isInteger(e.id)||typeof(e==null?void 0:e.name)!="string"||!(e!=null&&e.name)||typeof(e==null?void 0:e.colony)!="string"||!(e!=null&&e.colony)||(e==null?void 0:e.description)==null||e!=null&&e.location&&(typeof e.location!="object"||!Number.isFinite(e.location.latitude)||!Number.isFinite(e.location.longitude)||e.location.altitude&&!Number.isFinite(e.location.altitude)))):!1}function P(r,e){return Array.isArray(e)?e.every(t=>!(!r.includes(t.personId)||!t.date||new Date(t.date).toString()==="Invalid Date"||typeof(t==null?void 0:t.topic)!="string"||!(t!=null&&t.topic)||!t.returnDate||new Date(t.returnDate).toString()==="Invalid Date")):!1}async function h(r){if(!confirm(`¿Segura que deseas importar estos datos?
Esto sobreescribirá los datos actuales.`))return;const t=r.target.files;if(!(t!=null&&t[0])){alert("Error en importación de datos");return}try{const o=t[0],n=JSON.parse(await o.text());if(!N(n==null?void 0:n.people))throw new Error("Error en estructura de archivo");const C=n.people.map(({id:a})=>a);if(!P(C,n.returnVisits))throw new Error("Error en estructura de archivo");await i.mutateAsync(n.people.map(a=>({id:a.id,name:a.name,colony:a.colony,description:a.description,location:a.location?{latitude:a.location.latitude,longitude:a.location.longitude,altitude:a.location.altitude}:void 0}))),await f.mutateAsync(n.returnVisits.map(a=>({personId:a.personId,date:new Date(a.date),topic:a.topic,returnDate:new Date(a.returnDate),notes:a.notes}))),c.back()}catch(o){alert(o instanceof Error?o.message:"Error en la importación")}}return(r,e)=>(F(),q("main",J,[p("div",T,[y(g,{color:"asparagus",href:E.value,download:_.value,external:""},{default:v(()=>e[1]||(e[1]=[b(" Exportar datos ")])),_:1},8,["href","download"]),p("input",{ref_key:"fileInput",ref:d,class:"hidden",onChange:h,type:"file",accept:".return-visits,application/json"},null,544),y(g,{loading:w(f).isPending.value||w(i).isPending.value,color:"lemon",onClick:e[0]||(e[0]=t=>{var o;return(o=d.value)==null?void 0:o.click()})},{default:v(()=>e[2]||(e[2]=[b(" Importar datos ")])),_:1},8,["loading"])])]))}});export{z as default};
