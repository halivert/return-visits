import{A as P,x as k,B as J,C as Y,k as w,g as u,u as A,E as B,a as W,G as X,d as Z,H as V,r as ee,I as te,i as ae,c as i,F as S,l as v,t as f,w as re,b as n,y as b,J as oe,n as h,f as M,e as g,z as D,m as ne,q as le,h as se,v as ue,o as d}from"./index-CND7rFqX.js";import{u as N}from"./useMutation-BPaJKNXQ.js";function $({personId:o,date:p}){return P({queryKey:k.detail(o,p),queryFn:({queryKey:c})=>J("returnVisits",[c[2],c[3]])})}function T(o){return o?[o.getFullYear(),(o.getMonth()+1).toString().padStart(2,"0"),o.getDate().toString().padStart(2,"0")].join("-"):""}function F(o){return o?[o.getHours().toString().padStart(2,"0"),o.getMinutes().toString().padStart(2,"0")].join(":"):""}function ie(){return P({queryKey:k.all(),queryFn:()=>Y("returnVisits")})}function de({personId:o}={}){const p=ie();return w(()=>{var c,m;return new Set((m=(c=p.data.value)==null?void 0:c.filter(s=>u(o)==null?!0:s.personId===u(o)))==null?void 0:m.map(({topic:s})=>s))})}function pe({personId:o,date:p}){const c=A(),{data:m}=$({personId:o,date:p});return N({mutationFn:w(()=>async s=>{if(!m.value)return Promise.reject(new Error("Revisita no encontrada"));const x={...m.value,...s};return u(o)!==x.personId||u(p).toISOString()!==x.date.toISOString()?(await B("returnVisits",[u(o),u(p)]),await W("returnVisits",x)):await X("returnVisits",[u(o),u(p)],x),x}),onSuccess:s=>{c.invalidateQueries({queryKey:k.list(s.personId)}),c.setQueryData(k.detail(s.personId,s.date),s),s.personId!==u(o)&&c.invalidateQueries({queryKey:k.list(o)}),(s.personId!==u(o)||s.date!==u(p))&&c.invalidateQueries({queryKey:k.detail(o,p)})}})}function ce({personId:o,date:p}){const c=A();return N({mutationFn:w(()=>async()=>{await B("returnVisits",[u(o),u(p)])}),onSuccess:()=>{c.invalidateQueries({queryKey:k.all()})}})}const me={class:"col-span-2"},ve=["value"],fe={key:0,class:"text-chili-600"},ye={class:"col-span-2"},ge={class:"flex flex-wrap gap-2"},xe={key:0,class:"text-chili-600"},be={key:0},he={class:"col-span-2"},ke={key:0,class:"text-chili-600"},we={id:"topicDataList"},De={class:"col-span-2"},Se={class:"flex flex-wrap gap-2"},Ie=["min"],Te={key:0,class:"text-chili-600"},Fe={key:0},qe={class:"col-span-2"},Ce={key:0,class:"text-chili-600"},Ue=Z({__name:"ReturnVisitsEdit",props:{id:{},date:{}},setup(o){var C,R,Q,U,E,K,L;const p=se(),c=o,m=w(()=>c.id),s=w(()=>c.date),x=pe({personId:m,date:s}),j=ce({personId:m,date:s}),I=$({personId:m,date:s}),y=w(()=>I.data.value),_=de(),z=V(),q=w(()=>z.data.value??[]),e=ee({}),a=te({personId:(C=y.value)==null?void 0:C.personId,topic:(R=y.value)==null?void 0:R.topic,date:T((Q=y.value)==null?void 0:Q.date),time:F((U=y.value)==null?void 0:U.date),returnDate:T((E=y.value)==null?void 0:E.returnDate),returnTime:F((K=y.value)==null?void 0:K.returnDate),notes:(L=y.value)==null?void 0:L.notes});ae(y,r=>{a.personId=r==null?void 0:r.personId,a.topic=r==null?void 0:r.topic,a.date=T(r==null?void 0:r.date),a.time=F(r==null?void 0:r.date),a.returnDate=T(r==null?void 0:r.returnDate),a.returnTime=F(r==null?void 0:r.returnDate),a.notes=r==null?void 0:r.notes});async function O(){try{await j.mutateAsync(),p.back()}catch(r){console.info(r)}}async function G(){if(a.personId||(e.value={...e.value,personId:"Elige a la persona"}),a.topic||(e.value={...e.value,topic:"Falta tema"}),a.date||(e.value={...e.value,date:"Falta fecha"}),a.time||(e.value={...e.value,time:"Falta hora"}),a.returnDate||(e.value={...e.value,returnDate:"Falta fecha de revisita"}),a.returnTime||(e.value={...e.value,returnTime:"Falta hora de revisita"}),!Object.values(e.value).some(Boolean))try{await x.mutateAsync({personId:a.personId,date:new Date(a.date+"T"+a.time),topic:a.topic,returnDate:new Date(a.returnDate+"T"+a.returnTime),notes:a.notes}),p.replace({name:"PeopleShow",params:{id:m.value}})}catch(r){console.info(r)}}return(r,t)=>{const H=ue("RouterLink");return d(),i("div",null,[u(I).isLoading.value?(d(),i(S,{key:0},[v("Cargando...")],64)):u(I).error.value||!y.value?(d(),i(S,{key:1},[v(f(u(I).error.value||"Error"),1)],64)):(d(),i("form",{key:2,class:"grid grid-cols-3 gap-2 gap-y-3",onSubmit:re(G,["prevent"])},[q.value.length>1?(d(),i(S,{key:0},[t[12]||(t[12]=n("label",{class:"text-right",for:"personId"},"Persona",-1)),n("div",me,[b(n("select",{id:"personId",class:h(["w-full h-8 px-2 py-1 border dark:text-lemon-50",e.value.personId?"border-chili-400 accent-chili-600":"border-asparagus-100 accent-asparagus-600"]),"onUpdate:modelValue":t[0]||(t[0]=l=>a.personId=l)},[(d(!0),i(S,null,M(q.value,l=>(d(),i("option",{key:l.id,value:l.id},f(l.name),9,ve))),128))],2),[[oe,a.personId]]),e.value.personId?(d(),i("small",fe,f(e.value.personId),1)):g("",!0)])],64)):g("",!0),t[14]||(t[14]=n("div",{class:"text-right"},[n("label",{for:"date"},"Fecha"),v(" y "),n("label",{for:"time"},"hora")],-1)),n("div",ye,[n("div",ge,[b(n("input",{id:"date",class:h(["block dark:text-lemon-50 px-2 py-1 max-w-full rounded-sm border","h-8 flex-1",e.value.date?"border-chili-400 accent-chili-600":"border-asparagus-100 accent-asparagus-600"]),type:"date",name:"date","onUpdate:modelValue":t[1]||(t[1]=l=>a.date=l),onInput:t[2]||(t[2]=l=>e.value.date=""),required:""},null,34),[[D,a.date]]),b(n("input",{id:"time",class:h(["block dark:text-lemon-50 px-2 py-1 max-w-full rounded-sm border","h-8 flex-1",e.value.time?"border-chili-400 accent-chili-600":"border-asparagus-100 accent-asparagus-600"]),type:"time",name:"time","onUpdate:modelValue":t[3]||(t[3]=l=>a.time=l),onInput:t[4]||(t[4]=l=>e.value.time=""),required:""},null,34),[[D,a.time]])]),e.value.date||e.value.time?(d(),i("small",xe,[v(f(e.value.date)+" ",1),e.value.date&&e.value.time?(d(),i("br",be)):g("",!0),v(" "+f(e.value.time),1)])):g("",!0)]),t[15]||(t[15]=n("label",{class:"text-right",for:"topic"},"Tema",-1)),n("div",he,[b(n("input",{id:"topic",class:h(["block dark:text-lemon-50 px-2 py-1 max-w-full rounded-sm border","h-8 w-full",e.value.topic?"border-chili-400 accent-chili-600":"border-asparagus-100 accent-asparagus-600"]),type:"string",name:"topic","onUpdate:modelValue":t[5]||(t[5]=l=>a.topic=l),onInput:t[6]||(t[6]=l=>e.value.topic=""),list:"topicDataList",required:""},null,34),[[D,a.topic]]),e.value.topic?(d(),i("small",ke,f(e.value.topic),1)):g("",!0),n("datalist",we,[(d(!0),i(S,null,M(u(_),l=>(d(),i("option",{key:l},f(l),1))),128))])]),t[16]||(t[16]=n("div",{class:"text-right"},[n("label",{for:"returnDate"},"Fecha"),v(" y "),n("label",{for:"returnTime"},"hora"),v(" de revisita ")],-1)),n("div",De,[n("div",Se,[b(n("input",{id:"returnDate",class:h(["block dark:text-lemon-50 px-2 py-1 max-w-full rounded-sm border","h-8 flex-1",e.value.returnDate?"border-chili-400 accent-chili-600":"border-asparagus-100 accent-asparagus-600"]),type:"date",name:"returnDate","onUpdate:modelValue":t[7]||(t[7]=l=>a.returnDate=l),min:a.date,onChange:t[8]||(t[8]=l=>e.value.returnDate=""),required:""},null,42,Ie),[[D,a.returnDate]]),b(n("input",{id:"returnTime",class:h(["block dark:text-lemon-50 px-2 py-1 max-w-full rounded-sm border","h-8 flex-1",e.value.returnTime?"border-chili-400 accent-chili-600":"border-asparagus-100 accent-asparagus-600"]),type:"time",name:"returnTime","onUpdate:modelValue":t[9]||(t[9]=l=>a.returnTime=l),onInput:t[10]||(t[10]=l=>e.value.returnTime=""),required:""},null,34),[[D,a.returnTime]])]),e.value.returnDate||e.value.returnTime?(d(),i("small",Te,[v(f(e.value.returnDate)+" ",1),e.value.returnDate&&e.value.returnTime?(d(),i("br",Fe)):g("",!0),v(" "+f(e.value.returnTime),1)])):g("",!0)]),t[17]||(t[17]=n("label",{class:"text-right",for:"notes"},"Notas",-1)),n("div",qe,[b(n("textarea",{id:"notes",class:h(["block dark:text-lemon-50 px-2 py-1 max-w-full rounded-sm border","resize-y min-h-16 max-h-72 w-full",e.value.notes?"border-chili-400 accent-chili-600":"border-asparagus-100 accent-asparagus-600"]),rows:"8","onUpdate:modelValue":t[11]||(t[11]=l=>a.notes=l),name:"notes",maxlength:"250"},null,2),[[D,a.notes]]),e.value.notes?(d(),i("small",Ce,f(e.value.notes),1)):g("",!0)]),ne(H,{class:"col-start-2 border underline border-asparagus-600 rounded px-2 py-1 text-asparagus-600 text-center",to:{name:"PeopleShow",params:{id:r.id}}},{default:le(()=>t[13]||(t[13]=[v(" Cancelar ")])),_:1},8,["to"]),t[18]||(t[18]=n("button",{class:"bg-asparagus-600 rounded px-2 py-1 text-lemon-50",type:"submit"}," Guardar ",-1)),n("button",{class:"col-start-2 bg-fawn-600 rounded px-2 py-1 text-fawn-50 text-center",onClick:O,type:"button"}," Eliminar ")],32))])}}});export{Ue as default};
